<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nomad Nexus</title>
</head>
{{> message}}
<body style="font-family: 'Arial', sans-serif; color: #333; padding: 20px; background-color: #f8f8f8; text-align: center;">
    {{#if user}}
        <h1 style="color: #4a90e2;">Welcome, {{user.first_name}}!</h1>
        <p style="margin-bottom: 30px;">Let's plan your next trip:</p>
        <form id="tripForm" action="/trip" method="post" style="display: inline-block; text-align: left; background-color: #fff; padding: 40px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); border-radius: 8px;">
            <!-- Radio buttons to toggle the form -->
            <div style="margin-bottom: 20px;">
                <input type="radio" id="choose" name="tripType" value="choose" checked onclick="toggleFormFields()">
                <label for="choose">I know where I want to go</label>
            </div>
            <div style="margin-bottom: 20px;">
                <input type="radio" id="recommend" name="tripType" value="recommend" onclick="toggleFormFields()">
                <label for="recommend">Recommend a destination</label>
            </div>

            <!-- Destination field -->
            <div id="destinationField" style="margin-bottom: 20px;">
                <label for="destination">Your Destination:</label>
                <input type="text" id="destination" name="destination" list="destinationList" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <datalist id="destinationList"></datalist>
            </div>




            <!-- Travel dates field (shown in both cases) -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px;">When will you be going?</label>
                <div style="display: flex; justify-content: space-between;">
                    <div style="flex-grow: 1; margin-right: 10px;">
                        <label for="startDate" style="display: block; margin-bottom: 5px;">Arrival:</label>
                        <input type="date" id="startDate" name="startDate" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" title="Arrival">
                    </div>
                    <div style="flex-grow: 1;">
                        <label for="endDate" style="display: block; margin-bottom: 5px;">Departure:</label>
                        <input type="date" id="endDate" name="endDate" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" title="Departure">
                    </div>
                </div>
            </div>

            <!-- Budget field (always shown) -->
            <div style="margin-bottom: 20px; position: relative;">
                <label for="budget" style="display: block; margin-bottom: 5px;">Your Budget ($):</label>
                <input type="number" id="budget" name="budget" value="0" required step="500" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <button type="button" onclick="incrementBudget()" style="position: absolute; right: 0; top: 50%; transform: translateY(-15%); width: 30px; height: 30px;">+</button>
                <button type="button" onclick="decrementBudget()" style="position: absolute; right: 30px; top: 50%; transform: translateY(-15%); width: 30px; height: 30px;">-</button>
            </div>


            <!-- Travel method field (shown in both cases) -->
            <div id="travelMethodField" style="margin-bottom: 20px;">
                <label for="travelMethod" style="display: block; margin-bottom: 5px;">Preferred Means of Travel:</label>
                <select id="travelMethod" name="travelMethod" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="air">Air</option>
                    <option value="car">Car</option>
                    <option value="train">Train</option>
                    <option value="ship">Ship</option>
                </select>
            </div>

            <!-- Travel preferences field -->
            <div id="travelPreferences" style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px;">What are your trip preferences?</label>
                <div>
                    <div style="margin-bottom: 10px;">
                        <input type="checkbox" id="mountains" name="tripPreferences" value="mountains">
                        <label for="mountains">Mountains</label>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <input type="checkbox" id="beach" name="tripPreferences" value="beach">
                        <label for="beach">Beach</label>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <input type="checkbox" id="city" name="tripPreferences" value="city">
                        <label for="city">City</label>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <input type="checkbox" id="countryside" name="tripPreferences" value="countryside">
                        <label for="countryside">Countryside</label>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <input type="checkbox" id="historicSites" name="tripPreferences" value="historicSites">
                        <label for="historicSites">Historic Sites</label>
                    </div>
                </div>
            </div>

            <!-- Submit button -->
            <button type="submit" style="background-color: #5cb85c; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; width: 100%;">Plan Trip</button>
        </form>
    {{else}}
        <h1>Welcome to Nomad Nexus!</h1>
        <p>To access personalized trip planning, please <a href="/login" style="color: #4a90e2; text-decoration: none;">login</a> or <a href="/register" style="color: #4a90e2; text-decoration: none;">register</a>.</p>
    {{/if}}
        <script type="text/javascript">
            function toggleFormFields() {
                var knowWhereToGo = document.getElementById('choose').checked;
                var destinationField = document.getElementById('destinationField');
                var travelMethodField = document.getElementById('travelMethodField');
                var travelPreferencesField = document.getElementById('travelPreferences');
                var destinationInput = document.getElementById('destination');

                if (knowWhereToGo) {
                    destinationField.style.display = '';
                    travelMethodField.style.display = '';
                    travelPreferencesField.style.display = 'none';
                    document.getElementById('budget').value = '0';
                    document.querySelectorAll('#travelPreferences input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    destinationInput.setAttribute('required', 'required');
                    destinationInput.value = '';
                } else {
                    destinationField.style.display = 'none';
                    travelMethodField.style.display = '';
                    travelPreferencesField.style.display = '';
                    document.getElementById('budget').value = '0';
                    travelPreferencesField.value = '';
                    destinationInput.removeAttribute('required'); 
                    destinationInput.value = '';
                }
                // Attach event listeners to radio buttons
                document.getElementById('choose').addEventListener('change', toggleFormFields);
                document.getElementById('recommend').addEventListener('change', toggleFormFields);
            }

            function setDepartureDate() {
                var arrivalDate = document.getElementById('startDate').value;
                var departureInput = document.getElementById('endDate');
                departureInput.min = arrivalDate;
                if (departureInput.value && arrivalDate > departureInput.value) {
                    departureInput.value = arrivalDate;
                }
            }

            function setMinStartDate() {
                var today = new Date().toISOString().split('T')[0];
                document.getElementById('startDate').min = today;
                document.getElementById('startDate').addEventListener('change', setDepartureDate);
            }

             // This function now only prepares the validation and does not display it
            function prepareValidation() {
                var firstPreferenceCheckbox = document.getElementById('mountains');
                var checkboxes = document.querySelectorAll('input[name="tripPreferences"]:checked');
                
                if (!document.getElementById('choose').checked && checkboxes.length === 0) {
                    firstPreferenceCheckbox.setCustomValidity('Please choose at least one trip preference');
                } else {
                    firstPreferenceCheckbox.setCustomValidity('');
                }
            }

            // The event listener for form submission
            document.getElementById('tripForm').addEventListener('submit', function(event) {
                prepareValidation(); // Prepare the validation first

                // Then display the validation message or clear it
                var isValid = document.getElementById('mountains').checkValidity();
                if (!isValid) {
                    event.preventDefault(); // Prevent form from submitting if not valid
                    document.getElementById('mountains').reportValidity();
                }
            });

            // Initialize on DOMContentLoaded
            document.addEventListener('DOMContentLoaded', function() {
                toggleFormFields(); // To set up the initial display state
                setMinStartDate();  // To ensure date fields are not set in the past
            });

            // Attach change event listeners to checkboxes to clear validation message when any is checked
            document.querySelectorAll('input[name="tripPreferences"]').forEach(function(checkbox) {
                checkbox.addEventListener('change', function() {
                    document.getElementById('mountains').setCustomValidity('');
                });
            });
            function incrementBudget() {
                var budgetInput = document.getElementById('budget');
                budgetInput.value = parseInt(budgetInput.value) + 500; // Increment by 500
            }

            function decrementBudget() {
                var budgetInput = document.getElementById('budget');
                var currentValue = parseInt(budgetInput.value);
                if (currentValue >= 500) { // Ensure it doesn't go below 0
                budgetInput.value = currentValue - 500; // Decrement by 500
                }
            }
            
            document.addEventListener('DOMContentLoaded', function() {
                const destinationInput = document.getElementById('destination');
                const dataList = document.getElementById('destinationList');

                // Clear datalist options
                function clearDataList() {
                    dataList.innerHTML = '';
                }

                destinationInput.addEventListener('input', function() {
                    const value = destinationInput.value;
                    if (value.length > 1) {
                        fetch(`/api/cities?q=${encodeURIComponent(value)}`)
                            .then(response => response.json())
                            .then(data => {
                                clearDataList(); // Clear previous options
                                data.forEach(cityName => {
                                    const option = document.createElement('option');
                                    option.value = cityName;
                                    dataList.appendChild(option);
                                });
                            })
                            .catch(error => console.error('Error fetching cities:', error));
                    } else {
                        clearDataList(); // Clear the list if under two characters
                    }
                });

                // Event to handle selection or clicking outside the input
                destinationInput.addEventListener('blur', function() {
                    setTimeout(clearDataList, 10); // Delay clear to ensure selection can be processed
                });

                // Ensure the datalist is cleared after a selection matches
                destinationInput.addEventListener('change', function() {
                    const currentInput = destinationInput.value;
                    let matchFound = false;
                    const options = dataList.options;
                    for (let i = 0; i < options.length; i++) {
                        if (options[i].value === currentInput) {
                            matchFound = true;
                            break;
                        }
                    }
                    if (matchFound) {
                        setTimeout(clearDataList, 10); // Delay clear to prevent immediate reappear
                    }
                });
            });


    // Event to clear the datalist when a selection is confirmed


    destinationInput.addEventListener('blur', function() {
        dataList.innerHTML = ''; // Clear the datalist when input loses focus
    });
        </script>
</body>
</html>
